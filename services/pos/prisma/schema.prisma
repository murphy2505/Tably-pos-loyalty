datasource db {
  provider     = "sqlite"
  url          = "file:./dev.db"
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

//
// ==========================
//  CATEGORY / GROUPS
// ==========================
//

model Category {
  id        String    @id @default(cuid())
  tenantId  String
  name      String
  color     String?
  order     Int
  parentId  String?

  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")

  products  Product[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, name])
}

model RevenueGroup {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  color     String?
  products  Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@unique([tenantId, name])
}

//
// ==========================
//  PRODUCT + VARIANTS
// ==========================
//

model Product {
  id             String        @id @default(cuid())
  tenantId       String
  categoryId     String
  name           String
  active         Boolean       @default(true)
  vatRate        Float         @default(9)

  tileColor      String?
  tileIcon       String?
  imageUrl       String?

  // Kitchen / longpress / KDS / info
  description    String?
  shortLabel     String?
  kitchenNotes   String?
  recipe         String?       // receptuur tekst
  preparation    String?       // bereidingswijze KDS

  // Diet / kenmerken
  isVegetarian   Boolean       @default(false)
  isVegan        Boolean       @default(false)
  isGlutenFree   Boolean       @default(false)
  isLactoseFree  Boolean       @default(false)
  spicyLevel     Int?

  // POS functionaliteit
  tracksStock    Boolean       @default(false)
  printGroup     String?
  isCombo        Boolean       @default(false)

  // Relations
  category       Category      @relation(fields: [categoryId], references: [id])
  revenueGroupId String?
  revenueGroup   RevenueGroup? @relation(fields: [revenueGroupId], references: [id])

  variants       ProductVariant[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([tenantId])
  @@index([categoryId])
  @@index([revenueGroupId])
  @@unique([tenantId, categoryId, name])
}

model ProductVariant {
  id           String   @id @default(cuid())
  productId    String
  name         String
  price        Decimal
  costPrice    Decimal?
  sku          String?
  pluCode      String?
  active       Boolean  @default(true)

  product      Product   @relation(fields: [productId], references: [id])
  ingredients  ProductIngredient[]
  orderItems   OrderItem[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([productId])
  @@unique([productId, name])
}

//
// ==========================
//  STOCK / INGREDIENTS
// ==========================
//

model StockItem {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  unit        String
  quantity    Decimal   @default(0)
  minimum     Decimal   @default(0)
  allergens   String?   // CSV of JSON

  movements   StockMovement[]
  ingredients ProductIngredient[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@unique([tenantId, name])
}

model ProductIngredient {
  id          String  @id @default(cuid())
  variantId   String
  stockItemId String
  amount      Decimal

  variant     ProductVariant @relation(fields: [variantId], references: [id])
  stockItem   StockItem      @relation(fields: [stockItemId], references: [id])

  @@index([variantId])
  @@index([stockItemId])
}

model StockMovement {
  id           String    @id @default(cuid())
  stockItemId  String
  type         String    // PURCHASE | SALE | WASTE | ADJUSTMENT | SALE_CANCEL
  amount       Decimal
  createdAt    DateTime  @default(now())

  employeeId   String?
  employee     Employee? @relation(fields: [employeeId], references: [id])

  orderItemId  String?
  orderItem    OrderItem? @relation(fields: [orderItemId], references: [id])

  reversalOfId String?

  stockItem    StockItem @relation(fields: [stockItemId], references: [id])

  @@index([stockItemId])
  @@index([createdAt])
  @@index([employeeId])
  @@index([orderItemId])
}

//
// ==========================
//  EMPLOYEES / TABLES
// ==========================
//

model Employee {
  id         String          @id @default(cuid())
  tenantId   String
  name       String
  pinCode    String?
  role       String?

  orders     Order[]
  payments   Payment[]
  stockMoves StockMovement[]

  @@index([tenantId])
}

model Table {
  id         String   @id @default(cuid())
  tenantId   String
  locationId String
  name       String
  state      String   // FREE | SEATED | BILL_OPEN

  @@index([tenantId, locationId])
}

//
// ==========================
//  ORDERS / PAYMENTS / SNAPSHOTS
// ==========================
//

model Order {
  id           String      @id @default(cuid())
  tenantId     String
  locationId   String
  tableId      String?
  status       String
  createdAt    DateTime    @default(now())

  cancelledAt  DateTime?
  cancelReason String?

  employeeId   String?
  employee     Employee? @relation(fields: [employeeId], references: [id])

  deviceId     String?
  source       String?   // POS | WEB | APP | KIOSK | CALL
  dineType     String?   // TAKEAWAY | EATIN | DELIVERY

  items        OrderItem[]
  payments     Payment[]

  @@index([tenantId, locationId])
  @@index([tableId])
  @@index([status])
  @@index([createdAt])
  @@index([employeeId])
  @@index([deviceId])
}

model OrderItem {
  id               String          @id @default(cuid())
  orderId          String
  variantId        String
  quantity         Int
  priceEach        Decimal
  discount         Decimal         @default(0)

  // --- SNAPSHOTS ---
  productId        String
  productName      String
  variantName      String
  categoryId       String?
  categoryName     String?
  revenueGroupId   String?
  revenueGroupName String?
  vatRateSnapshot  Decimal
  allergensSummary String?

  order            Order          @relation(fields: [orderId], references: [id])
  variant          ProductVariant @relation(fields: [variantId], references: [id])

  stockMovements   StockMovement[]

  @@index([orderId])
  @@index([variantId])
  @@index([revenueGroupId])
}

model Payment {
  id          String    @id @default(cuid())
  orderId     String
  method      String
  amount      Decimal
  createdAt   DateTime  @default(now())

  employeeId  String?
  employee    Employee? @relation(fields: [employeeId], references: [id])

  order       Order     @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([createdAt])
  @@index([employeeId])
}
